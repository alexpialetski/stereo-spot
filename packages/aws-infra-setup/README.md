# Terraform Backend: AWS S3

This package (`aws-infra-setup`) provisions the AWS infrastructure required for a remote Terraform state backend using S3 and optional locking features.

## ğŸ“‹ Overview

This backend includes:

- **S3 Bucket** for Terraform state storage with versioning and object lock
- **Backend Configuration** file generation for cluster package initialization
- **State sync script** so the bucket is tracked correctly when state is absent or when the AWS account changes

## ğŸ—ï¸ Resources Created

### S3 Bucket (`aws_s3_bucket.tf_state`)

- **Purpose**: Stores Terraform state for the cluster infrastructure
- **Features**:
  - Versioning enabled for state history
  - Object lock enabled for state protection
  - Force destroy disabled (set to `false`) for safety
- **Naming**: `terraform-state-${account_id}-${region}` (AWS account id + region)

### Backend Configuration (`local_file.backend_config`)

- **Purpose**: Generates `backend.config` file for cluster initialization
- **Content**: S3 bucket name, key, and region configuration
- **Usage**: Referenced by cluster package Terraform initialization

### State sync before plan (`scripts/sync_backend_state.sh`)

- **Purpose**: Keeps Terraform state aligned with the real backend bucket when state is missing or stale (e.g. lost state file or switched AWS account).
- **When**: Run automatically as part of the **terraform-plan** target (before `terraform plan -out=tfplan`).
- **Logic**:
  1. Resolves bucket name (same as Terraform: `terraform-state-<account_id>-<region>`).
  2. Checks if the bucket exists in AWS (`head-bucket`).
  3. If the bucket exists but state does not track it â†’ runs `terraform import` for the bucket, versioning, and object lock.
  4. If the bucket exists and state tracks it but a dry plan would destroy it (stale state) â†’ removes those resources from state, re-imports, then continues.
  5. Runs `terraform plan -out=tfplan`.

So: **terraform-init** is unchanged; **terraform-plan** runs the sync script then `terraform plan -out=tfplan`; **terraform-apply** is unchanged.

## ğŸ” Security Considerations

### S3 Bucket Security

- **Versioning**: Enabled to track state changes
- **Object Lock**: Prevents accidental state deletion
- **Access Control**: Controlled through IAM policies

### Additional Security

For production environments, additionally consider:

- KMS encryption for S3 bucket
- Bucket policies for access control
- VPC endpoints for S3 access
- **Lifecycle Policies**: Can be configured for state retention
- **Monitoring**: CloudTrail logging for audit and compliance

## ğŸ”„ Dependencies

- **Upstream**: AWS Provider configuration
- **Downstream**: Packages that depend on initialized backend

## ğŸ“Š Outputs

Generated by the Nx Terraform backend generator (type: aws-s3).

- **backend.config**: Backend configuration for cluster package Terraform initialization
- **S3 bucket**: Terraform state storage with versioning and object lock enabled

After creation, other Terraform modules can reference the generated `backend.config` file for initialization.

## ğŸ§ª Validation

Run **terraform-plan** (e.g. `nx run aws-infra-setup:terraform-plan`). The sync script ensures the bucket is imported when it already exists and state is absent or stale, then produces the plan. Use **terraform-apply** as usual to apply.
