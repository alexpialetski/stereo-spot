{% extends "base.html" %}
{% block title %}Job {{ job.title or job.job_id }} — Stereo-Spot{% endblock %}
{% block content %}
<h1>Job {{ job.title or job.job_id }}</h1>
<p><strong>Mode:</strong> {{ job.mode.value }}</p>

{% if upload_url %}
<article>
  <h2>Upload your video</h2>
  <div id="upload-area" data-upload-url="{{ upload_url }}" data-job-id="{{ job.job_id }}"{% if settings.show_eta %} data-eta-seconds-per-mb="{{ settings.eta_seconds_per_mb }}" data-eta-cloud="{{ settings.eta_cloud_name }}"{% endif %}>
    <label for="source-file">Choose an MP4 file:</label>
    <input type="file" id="source-file" name="source" accept=".mp4,video/mp4">
    <button type="button" id="upload-btn" disabled>Upload file</button>
    <p id="upload-status" aria-live="polite"></p>
    {% if settings.show_eta %}
    <p id="eta-message" aria-live="polite" style="display: none;"></p>
    {% endif %}
  </div>
  <p>After uploading, the chunking worker will process the file automatically. Progress will update below.</p>
</article>
{% endif %}

{% if job.status.value != "completed" %}
<article>
  <h2>Progress</h2>
  <p id="stage-label" aria-live="polite">{{ stage_label }}</p>
  <progress id="progress-bar" value="{{ progress_percent }}" max="100">{{ progress_percent }}%</progress>
</article>
{% else %}
<article>
  <h2>Final video</h2>
  {% if playback_url %}
  <video src="{{ playback_url }}" controls preload="metadata" style="width: 100%; display: block; margin-bottom: 1rem;"></video>
  <p><a href="{{ download_url }}" role="button">Download</a></p>
  {% endif %}
</article>
{% endif %}

{% if job.status.value == "completed" or job.status.value == "failed" %}
<article>
  <h2>Remove job</h2>
  <p>Permanently remove this job and its files. This cannot be undone.</p>
  <form action="/jobs/{{ job.job_id }}/delete" method="post" onsubmit="return confirm('Remove this job and its files?');">
    <button type="submit">Remove job</button>
  </form>
</article>
{% endif %}

{% if upload_url %}
<script>
(function () {
  var area = document.getElementById('upload-area');
  var fileInput = document.getElementById('source-file');
  var uploadBtn = document.getElementById('upload-btn');
  var statusEl = document.getElementById('upload-status');
  var uploadUrl = area.getAttribute('data-upload-url');

  fileInput.addEventListener('change', function () {
    uploadBtn.disabled = !fileInput.files.length;
    statusEl.textContent = '';
    var etaEl = document.getElementById('eta-message');
    if (etaEl) {
      var etaPerMb = parseFloat(area.getAttribute('data-eta-seconds-per-mb') || '0');
      var etaCloud = area.getAttribute('data-eta-cloud') || '';
      var file = fileInput.files[0];
      if (file && etaPerMb > 0) {
        var estimatedSeconds = (file.size / 1e6) * etaPerMb;
        var minutes = Math.round(estimatedSeconds / 60);
        var label = etaCloud ? 'Estimated time (' + etaCloud + '): ' : 'Estimated conversion time: ';
        etaEl.textContent = minutes < 1 ? label + '~1 min' : label + '~' + minutes + ' min';
        etaEl.style.display = 'block';
      } else {
        etaEl.textContent = '';
        etaEl.style.display = 'none';
      }
    }
  });

  uploadBtn.addEventListener('click', function () {
    var file = fileInput.files[0];
    if (!file) return;
    uploadBtn.disabled = true;
    statusEl.textContent = 'Uploading…';

    fetch(uploadUrl, {
      method: 'PUT',
      body: file,
      headers: { 'Content-Type': file.type || 'video/mp4' }
    }).then(function (res) {
      if (res.ok) {
        statusEl.textContent = 'Upload complete. Progress will update automatically.';
        fileInput.value = '';
        var jobId = area.getAttribute('data-job-id');
        if (jobId && file && file.name) {
          fetch('/jobs/' + jobId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: file.name })
          }).then(function () { window.location.reload(); }).catch(function () { window.location.reload(); });
        }
      } else {
        statusEl.textContent = 'Upload failed: ' + res.status + ' ' + res.statusText;
        uploadBtn.disabled = false;
      }
    }).catch(function (err) {
      statusEl.textContent = 'Upload failed: ' + err.message;
      uploadBtn.disabled = false;
    });
  });
})();
</script>
{% endif %}

{% if job.status.value != "completed" %}
<script>
(function () {
  var jobId = '{{ job.job_id }}';
  var progressBar = document.getElementById('progress-bar');
  var stageLabel = document.getElementById('stage-label');
  var es = new EventSource('/jobs/' + jobId + '/events');

  es.onmessage = function (e) {
    var data = JSON.parse(e.data);
    progressBar.value = data.progress_percent;
    progressBar.textContent = data.progress_percent + '%';
    stageLabel.textContent = data.stage_label;
    if (data.progress_percent >= 100) {
      es.close();
      window.location.reload();
    } else if (data.stage_label === 'Failed') {
      es.close();
    }
  };

  es.onerror = function () {
    es.close();
  };
})();
</script>
{% endif %}
{% endblock %}
